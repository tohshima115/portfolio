---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { ROLES } from "@/consts";

const projects = await getCollection("projects");

// Sort by date (newest first)
const sortedProjects = projects.sort((a, b) => {
    const dateA = new Date(a.data.meta.date);
    const dateB = new Date(b.data.meta.date);
    return dateB.getTime() - dateA.getTime();
});

// Helper to get role label from value
function getRoleLabel(value: string): string {
    const role = ROLES.find((r) => r.value === value);
    return role ? role.label : value;
}
---

<BaseLayout title="Works | Portfolio">
    <div class="min-h-screen bg-neutral-950 text-white relative overflow-hidden">

        <!-- Background Grid Pattern -->
        <div class="fixed inset-0 opacity-[0.03] pointer-events-none z-0"
            style="background-image: linear-gradient(rgba(255,255,255,0.1) 1px, transparent 1px), linear-gradient(90deg, rgba(255,255,255,0.1) 1px, transparent 1px); background-size: 40px 40px;">
        </div>

        <!-- Header Section -->
        <header class="relative z-10 pt-16 pb-12 px-6 md:px-12 lg:px-20 max-w-[1920px] mx-auto">

            <!-- Breadcrumb / System Path -->
            <div class="font-mono text-xs text-neutral-500 tracking-widest uppercase mb-8 flex items-center gap-2">
                <a href="/" class="hover:text-yellow-400 transition-colors duration-200">Home</a>
                <span class="text-neutral-600">/</span>
                <span class="text-neutral-400">Works</span>
            </div>

            <!-- Title Block -->
            <div class="relative mb-4">
                <div class="absolute -left-4 top-0 bottom-0 w-1 bg-yellow-400"></div>
                <h1 class="text-5xl md:text-7xl font-black uppercase tracking-tighter leading-none">
                    Works
                </h1>
                <p class="font-mono text-xs text-neutral-500 mt-3 tracking-widest uppercase">
                    Project_Archive â€” {sortedProjects.length} Entries
                </p>
            </div>

            <!-- Decorative Line -->
            <div class="mt-8 flex items-center gap-4">
                <div class="h-px flex-1 bg-gradient-to-r from-neutral-700 to-transparent"></div>
                <span class="font-mono text-[10px] text-neutral-600 tracking-[0.3em] uppercase">Index</span>
                <div class="h-px w-16 bg-neutral-700"></div>
            </div>
        </header>

        <!-- Projects Grid -->
        <main class="relative z-10 px-6 md:px-12 lg:px-20 pb-24 max-w-[1920px] mx-auto">
            <div class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 lg:gap-8">
                {sortedProjects.map((project, index) => (
                    <a
                        href={`/works/${project.slug}`}
                        class="group relative block bg-neutral-900/60 border border-neutral-800 hover:border-neutral-600 transition-all duration-500 overflow-hidden"
                        id={`project-card-${project.slug}`}
                    >
                        <!-- Index Number -->
                        <div class="absolute top-4 right-4 z-20 font-mono text-xs text-neutral-600 group-hover:text-yellow-400 transition-colors duration-300">
                            {String(index + 1).padStart(2, '0')}
                        </div>

                        <!-- Thumbnail -->
                        <div class="relative aspect-video bg-neutral-800 overflow-hidden">
                            {project.data.meta.thumbnail && (
                                <img
                                    src={project.data.meta.thumbnail.src}
                                    alt={project.data.title}
                                    class="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-105"
                                    loading="lazy"
                                />
                            )}
                            <!-- Gradient Overlay -->
                            <div class="absolute inset-0 bg-gradient-to-t from-neutral-900/80 via-transparent to-transparent opacity-60 group-hover:opacity-40 transition-opacity duration-500"></div>

                            <!-- Hover Indicator -->
                            <div class="absolute bottom-3 right-3 flex items-center gap-1.5 opacity-0 group-hover:opacity-100 transition-all duration-300 translate-x-2 group-hover:translate-x-0">
                                <span class="font-mono text-[10px] text-yellow-400 tracking-widest uppercase">View</span>
                                <svg class="w-3.5 h-3.5 text-yellow-400" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" />
                                </svg>
                            </div>
                        </div>

                        <!-- Card Content -->
                        <div class="p-5 space-y-4">
                            <!-- Title -->
                            <h2 class="text-lg font-bold tracking-tight leading-snug group-hover:text-yellow-400 transition-colors duration-300">
                                {project.data.title}
                            </h2>

                            <!-- Meta Info: Duration -->
                            <div class="flex items-center gap-2 font-mono text-[11px] text-neutral-500">
                                <span class="inline-block w-1.5 h-1.5 rounded-full bg-yellow-400/60"></span>
                                <span>{project.data.meta.duration}</span>
                            </div>

                            <!-- Roles Tags -->
                            <div class="flex flex-wrap gap-1.5">
                                {project.data.attributes.roles.map((role: string) => (
                                    <span class="inline-block px-2 py-0.5 text-[10px] font-mono tracking-wider uppercase text-neutral-400 bg-neutral-800 border border-neutral-700 group-hover:border-neutral-600 transition-colors duration-300">
                                        {getRoleLabel(role)}
                                    </span>
                                ))}
                            </div>

                            <!-- Tech Stack -->
                            <div class="pt-3 border-t border-neutral-800 flex flex-wrap gap-2">
                                {project.data.attributes.stack.map((tech: string) => (
                                    <span class="inline-block px-2 py-0.5 text-[10px] font-mono tracking-wide text-yellow-400/70 bg-yellow-400/5 border border-yellow-400/10">
                                        {tech}
                                    </span>
                                ))}
                            </div>
                        </div>

                        <!-- Bottom Accent Line (appears on hover) -->
                        <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-yellow-400 scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-left"></div>
                    </a>
                ))}
            </div>

            <!-- Footer / System Info -->
            <div class="mt-20 flex items-center gap-4">
                <div class="h-px flex-1 bg-neutral-800"></div>
                <span class="font-mono text-[10px] text-neutral-600 tracking-[0.3em] uppercase">
                    End_of_Archive
                </span>
                <div class="h-px flex-1 bg-neutral-800"></div>
            </div>
        </main>
    </div>
</BaseLayout>
