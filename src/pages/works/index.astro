---
import { getCollection } from "astro:content";
import BaseLayout from "@/layouts/BaseLayout.astro";
import { ROLES } from "@/consts";
import { SystemGraph } from "@/components/common/SystemGraph";

const projects = await getCollection("projects");
const blogs = await getCollection("blog"); // Will use later if we combine, for now just loading it if needed

// Sort by date (newest first)
const sortedProjects = projects.sort((a, b) => {
    const dateA = new Date(a.data.meta.date);
    const dateB = new Date(b.data.meta.date);
    return dateB.getTime() - dateA.getTime();
});

// Helper to get role label from value
function getRoleLabel(value: string): string {
    const role = ROLES.find((r) => r.value === value);
    return role ? role.label : value;
}

// Generate Graph Data combining Projects and Tags
const graphNodes: any[] = [];
const graphLinks: any[] = [];
const tagsSet = new Set<string>();

sortedProjects.forEach(project => {
    const projectId = `works-${project.slug}`;
    graphNodes.push({
        id: projectId,
        name: project.data.title,
        type: 'works',
        url: `/works/${project.slug}`
    });

    const stackTags = project.data.attributes.stack || [];
    stackTags.forEach((tech: string) => {
        const tagId = `tag-${tech}`;
        if (!tagsSet.has(tagId)) {
            tagsSet.add(tagId);
            graphNodes.push({
                id: tagId,
                name: tech,
                type: 'tag',
                url: `/works?tag=${encodeURIComponent(tech)}`
            });
        }
        graphLinks.push({
            source: projectId,
            target: tagId
        });
    });
});
---

<BaseLayout title="Works | Portfolio">
    <div class="min-h-screen bg-background text-foreground relative overflow-hidden">

        <!-- Background Grid Pattern -->
        <div class="fixed inset-0 opacity-40 pointer-events-none z-0"
            style="background-image: linear-gradient(rgba(0,0,0,0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.08) 1px, transparent 1px); background-size: 40px 40px;">
        </div>

        <!-- Header Section -->
        <header class="relative z-10 pt-16 pb-12 px-6 md:px-12 lg:px-20 max-w-[1920px] mx-auto">

            <!-- Breadcrumb / System Path -->
            <div class="font-mono text-xs text-muted-foreground tracking-widest uppercase mb-8 flex items-center gap-2">
                <a href="/" class="hover:text-accent transition-colors duration-200">Home</a>
                <span class="text-border">/</span>
                <span class="text-foreground">Works</span>
            </div>

            <!-- Title Block -->
            <div class="relative mb-4">
                <div class="absolute -left-4 top-0 bottom-0 w-1 bg-accent origin-top animate-line-drop"></div>
                <div class="overflow-hidden py-1">
                    <div class="animate-title-slide">
                        <h1 class="text-5xl md:text-7xl font-black uppercase tracking-tighter leading-none">
                            Works
                        </h1>
                        <p class="font-mono text-xs text-muted-foreground mt-3 tracking-widest uppercase">
                            Project_Archive — {sortedProjects.length} Entries
                        </p>
                    </div>
                </div>
            </div>

            <!-- Decorative Line -->
            <div class="mt-8 flex items-center gap-4">
                <div class="h-px flex-1 bg-gradient-to-r from-border to-transparent"></div>
                <span class="font-mono text-[10px] text-muted-foreground tracking-[0.3em] uppercase">Index</span>
                <div class="h-px w-16 bg-border"></div>
            </div>
        </header>

        <!-- Main Content Area: Responsive Grid -->
        <main class="relative z-10 px-6 md:px-12 lg:px-20 pb-24 max-w-[1920px] mx-auto">
            <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">
                
                <!-- Left Column: Projects List -->
                <div class="flex-1">
                <!-- Active Filter Banner -->
                <div id="filter-banner" class="hidden mb-6 flex items-center gap-3 p-3 bg-accent/10 border border-accent/30 font-mono text-xs">
                    <span class="text-muted-foreground uppercase tracking-wider">Filter:</span>
                    <span id="filter-tag-name" class="text-accent font-bold uppercase"></span>
                    <button id="filter-clear" class="ml-auto text-muted-foreground hover:text-accent transition-colors cursor-pointer flex items-center gap-1">
                        <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                        <span class="uppercase tracking-wider">Clear</span>
                    </button>
                </div>
                <div id="projects-grid" class="grid grid-cols-1 md:grid-cols-2 gap-6 lg:gap-8">
                        {sortedProjects.map((project, index) => {
                            // アニメーションのスタガー（ずらし）計算
                            const baseDelay = index * 0.08 + 0.1;
                            const imgDelay = baseDelay + 's';
                            const contentDelay = (baseDelay + 0.05) + 's';
                            const indexDelay = (baseDelay + 0.1) + 's';

                            return (
                            <a
                                href={`/works/${project.slug}`}
                                class="group relative block bg-background/80 backdrop-blur-sm border border-border hover:border-accent/40 shadow-sm transition-all duration-500 overflow-hidden project-card"
                                id={`project-card-${project.slug}`}
                                data-tags={JSON.stringify(project.data.attributes.stack.map((t: string) => t.toLowerCase()))}
                            >
                                <!-- Index Number -->
                                <div 
                                    class="absolute top-4 right-4 z-20 font-mono text-xs text-muted-foreground group-hover:text-accent transition-colors duration-300 animate-slide-from-right"
                                    style={`animation-delay: ${indexDelay};`}
                                >
                                    {String(index + 1).padStart(2, '0')}
                                </div>

                                <!-- Thumbnail -->
                                <div class="relative aspect-video bg-muted overflow-hidden">
                                    <div class="absolute inset-0 animate-slide-from-right" style={`animation-delay: ${imgDelay};`}>
                                        {project.data.meta.thumbnail && (
                                            <img
                                                src={project.data.meta.thumbnail.src}
                                                alt={project.data.title}
                                                class="w-full h-full object-cover transition-transform duration-700 ease-out group-hover:scale-105"
                                                loading="lazy"
                                            />
                                        )}
                                    </div>
                                    <!-- Gradient Overlay -->
                                    <div class="absolute inset-0 bg-gradient-to-t from-foreground/60 via-transparent to-transparent opacity-60 group-hover:opacity-40 transition-opacity duration-500"></div>

                                    <!-- Hover Indicator -->
                                    <div class="absolute bottom-3 right-3 flex items-center gap-1.5 opacity-0 group-hover:opacity-100 transition-all duration-300 translate-x-2 group-hover:translate-x-0">
                                        <span class="font-mono text-[10px] text-accent tracking-widest uppercase drop-shadow-md">View</span>
                                        <svg class="w-3.5 h-3.5 text-accent drop-shadow-md" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" />
                                        </svg>
                                    </div>
                                </div>

                                <!-- Card Content -->
                                <div 
                                    class="p-5 space-y-4 animate-slide-from-right"
                                    style={`animation-delay: ${contentDelay};`}
                                >
                                    <!-- Title -->
                                    <h2 class="text-lg font-bold tracking-tight leading-snug group-hover:text-accent transition-colors duration-300">
                                        {project.data.title}
                                    </h2>

                                    <!-- Meta Info: Duration -->
                                    <div class="flex items-center gap-2 font-mono text-[11px] text-muted-foreground">
                                        <span class="inline-block w-1.5 h-1.5 rounded-full bg-accent/60"></span>
                                        <span>{project.data.meta.duration}</span>
                                    </div>

                                    <!-- Roles Tags -->
                                    <div class="flex flex-wrap gap-1.5">
                                        {project.data.attributes.roles.map((role: string) => (
                                            <span class="inline-block px-2 py-0.5 text-[10px] font-mono tracking-wider uppercase text-muted-foreground bg-muted/40 border border-border group-hover:border-accent/30 transition-colors duration-300">
                                                {getRoleLabel(role)}
                                            </span>
                                        ))}
                                    </div>

                                    <!-- Tech Stack -->
                                    <div class="pt-3 border-t border-border flex flex-wrap gap-2">
                                        {project.data.attributes.stack.map((tech: string) => (
                                            <span class="inline-block px-2 py-0.5 text-[10px] font-mono tracking-wide text-accent bg-accent/10 border border-accent/20">
                                                {tech}
                                            </span>
                                        ))}
                                    </div>
                                </div>

                                <!-- Bottom Accent Line (appears on hover) -->
                                <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-accent scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-left"></div>
                            </a>
                        )})}
                    </div>
                    <!-- No results message -->
                    <div id="no-results" class="hidden py-12 text-center font-mono text-sm text-muted-foreground uppercase tracking-wider">
                        No projects found for this tag.
                    </div>
                </div>

                <!-- Right Column: System Graph -->
                <div class="w-full lg:w-[400px] xl:w-[500px] h-[500px] lg:h-[calc(100vh-200px)] lg:sticky lg:top-8 flex-shrink-0 animate-slide-from-right" style="animation-delay: 0.3s;">
                    <!-- Window Header Decor -->
                    <div class="flex items-center justify-between border-t border-x border-border bg-muted/30 px-3 py-1.5">
                        <span class="font-mono text-[9px] uppercase tracking-[0.2em] text-muted-foreground">Relation_Graph</span>
                        <div class="flex gap-1.5">
                            <div class="w-1.5 h-1.5 rounded-full bg-border"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-border"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-border"></div>
                        </div>
                    </div>
                    <!-- Client-only Graph -->
                    <SystemGraph 
                        client:only="react" 
                        nodes={graphNodes} 
                        links={graphLinks} 
                        className="rounded-t-none"
                    />
                </div>
            </div>

            <!-- Footer / System Info -->
            <div class="mt-20 flex items-center gap-4">
                <div class="h-px flex-1 bg-border"></div>
                <span class="font-mono text-[10px] text-muted-foreground tracking-[0.3em] uppercase">
                    End_of_Archive
                </span>
                <div class="h-px flex-1 bg-border"></div>
            </div>
        </main>
    </div>
</BaseLayout>

<style>
    .animate-line-drop {
        animation: scaleYDown 0.5s cubic-bezier(0.22, 1, 0.36, 1) both;
    }
    .animate-title-slide {
        animation: slideOutRight 0.7s cubic-bezier(0.22, 1, 0.36, 1) 0.1s both;
    }
    .animate-slide-from-right {
        animation: slideFromRight 0.8s cubic-bezier(0.22, 1, 0.36, 1) both;
        /* `both` specifies that animation preserves the final visual state and acts aggressively on load */
    }

    @keyframes scaleYDown {
        0% { transform: scaleY(0); }
        100% { transform: scaleY(1); }
    }
    @keyframes slideOutRight {
        0% { transform: translateX(-100%); opacity: 0; }
        20% { opacity: 1; }
        100% { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideFromRight {
        0% { transform: translateX(20px); opacity: 0; }
        15% { opacity: 1; } /* 最初の一瞬(15%)で不透明度が1になりフェードイン完了 */
        100% { transform: translateX(0); opacity: 1; } /* その後は徐々に減速しながら位置が安定 */
    }
</style>

<script>
    function applyFilter(tagName: string | null) {
        const banner = document.getElementById('filter-banner');
        const tagLabel = document.getElementById('filter-tag-name');
        const noResults = document.getElementById('no-results');
        const cards = document.querySelectorAll('.project-card') as NodeListOf<HTMLElement>;

        if (!tagName) {
            // Show all
            banner?.classList.add('hidden');
            cards.forEach(card => {
                card.style.display = '';
            });
            noResults?.classList.add('hidden');
            return;
        }

        // Show filter banner
        banner?.classList.remove('hidden');
        if (tagLabel) tagLabel.textContent = tagName;

        let visibleCount = 0;
        const lowerTag = tagName.toLowerCase();
        cards.forEach(card => {
            const tags: string[] = JSON.parse(card.dataset.tags || '[]');
            if (tags.includes(lowerTag)) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        if (visibleCount === 0) {
            noResults?.classList.remove('hidden');
        } else {
            noResults?.classList.add('hidden');
        }
    }

    // Apply filter from URL on load
    const params = new URLSearchParams(window.location.search);
    const initialTag = params.get('tag');
    if (initialTag) {
        applyFilter(initialTag);
    }

    // Clear filter button - full navigation to reset the graph component too
    document.getElementById('filter-clear')?.addEventListener('click', () => {
        window.location.href = '/works';
    });
</script>
