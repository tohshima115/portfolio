---
import BaseLayout from "@/layouts/BaseLayout.astro";
import { getCollection } from "astro:content";
import { SystemGraph } from "@/components/common/SystemGraph";

const posts = (await getCollection("blog")).sort(
    (a, b) => b.data.pubDate.valueOf() - a.data.pubDate.valueOf()
);

// Generate Graph Data combining Blogs and Tags
const graphNodes: any[] = [];
const graphLinks: any[] = [];
const tagsSet = new Set<string>();

posts.forEach(post => {
    const postId = `blog-${post.slug}`;
    graphNodes.push({
        id: postId,
        name: post.data.title,
        type: 'blog',
        url: `/blog/${post.slug}`
    });

    const stackTags = post.data.tags || [];
    stackTags.forEach((tech: string) => {
        const tagId = `tag-${tech}`;
        if (!tagsSet.has(tagId)) {
            tagsSet.add(tagId);
            graphNodes.push({
                id: tagId,
                name: tech,
                type: 'tag',
                url: `/blog?tag=${encodeURIComponent(tech)}`
            });
        }
        graphLinks.push({
            source: postId,
            target: tagId
        });
    });
});
---

<BaseLayout
    title="Blog | Portfolio"
    description="Development logs and thoughts."
>
    <div class="min-h-screen bg-background text-foreground relative overflow-hidden">

        <!-- Background Grid Pattern -->
        <div class="fixed inset-0 opacity-40 pointer-events-none z-0"
            style="background-image: linear-gradient(rgba(0,0,0,0.08) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.08) 1px, transparent 1px); background-size: 40px 40px;">
        </div>

        <!-- Header Section -->
        <header class="relative z-10 pt-16 pb-12 px-6 md:px-12 lg:px-20 max-w-[1920px] mx-auto">

            <!-- Breadcrumb / System Path -->
            <div class="font-mono text-xs text-muted-foreground tracking-widest uppercase mb-8 flex items-center gap-2">
                <a href="/" class="hover:text-accent transition-colors duration-200">Home</a>
                <span class="text-border">/</span>
                <span class="text-foreground">Blog</span>
            </div>

            <!-- Title Block -->
            <div class="relative mb-4">
                <div class="absolute -left-4 top-0 bottom-0 w-1 bg-accent origin-top animate-line-drop"></div>
                <div class="overflow-hidden py-1">
                    <div class="animate-title-slide">
                        <h1 class="text-5xl md:text-7xl font-black uppercase tracking-tighter leading-none">
                            Blog
                        </h1>
                        <p class="font-mono text-xs text-muted-foreground mt-3 tracking-widest uppercase">
                            System_Logs â€” {posts.length} Entries
                        </p>
                    </div>
                </div>
            </div>

            <!-- Decorative Line -->
            <div class="mt-8 flex items-center gap-4">
                <div class="h-px flex-1 bg-gradient-to-r from-border to-transparent"></div>
                <span class="font-mono text-[10px] text-muted-foreground tracking-[0.3em] uppercase">Index</span>
                <div class="h-px w-16 bg-border"></div>
            </div>
        </header>

        <!-- Main Content Area -->
        <main class="relative z-10 px-6 md:px-12 lg:px-20 pb-24 max-w-[1920px] mx-auto">
            <div class="flex flex-col lg:flex-row gap-8 lg:gap-12">
                
                <!-- Left Column: Blogs List -->
                <div class="flex-1 w-full lg:max-w-4xl">
                    <!-- Active Filter Banner -->
                    <div id="filter-banner" class="hidden mb-6 flex items-center gap-3 p-3 bg-accent/10 border border-accent/30 font-mono text-xs animate-slide-from-right">
                        <span class="text-muted-foreground uppercase tracking-wider">Filter:</span>
                        <span id="filter-tag-name" class="text-accent font-bold uppercase"></span>
                        <button id="filter-clear" class="ml-auto text-muted-foreground hover:text-accent transition-colors cursor-pointer flex items-center gap-1">
                            <svg class="w-3 h-3" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>
                            <span class="uppercase tracking-wider">Clear</span>
                        </button>
                    </div>

                    <div id="blog-grid">
                        {posts.length > 0 ? (
                            <div class="space-y-0">
                                {posts.map((post, index) => {
                                    const baseDelay = index * 0.08 + 0.1;
                                    const rowDelay = baseDelay + 's';
                                    const formattedDate = new Date(post.data.pubDate).toLocaleDateString("ja-JP", {
                                        year: "numeric",
                                        month: "2-digit",
                                        day: "2-digit",
                                    });

                                    return (
                                        <a
                                            href={`/blog/${post.slug}`}
                                            class="group relative block border-b border-border hover:bg-muted/30 transition-all duration-300 animate-slide-from-right blog-card"
                                            style={`animation-delay: ${rowDelay};`}
                                            id={`blog-entry-${post.slug}`}
                                            data-tags={JSON.stringify((post.data.tags || []).map((t: string) => t.toLowerCase()))}
                                        >
                                            <div class="flex items-start gap-4 md:gap-6 py-6 md:py-8">
                                                <!-- Index Number -->
                                                <div class="hidden md:flex flex-shrink-0 w-10 font-mono text-xs text-muted-foreground group-hover:text-accent transition-colors duration-300 pt-1">
                                                    {String(index + 1).padStart(2, '0')}
                                                </div>

                                                <!-- Content -->
                                                <div class="flex-1 min-w-0 space-y-2">
                                                    <!-- Title & Tags -->
                                                    <div class="flex items-center flex-wrap gap-2 mb-1">
                                                        <h2 class="text-lg md:text-xl font-bold tracking-tight leading-snug group-hover:text-accent transition-colors duration-300">
                                                            {post.data.title}
                                                        </h2>
                                                        {post.data.tags && post.data.tags.map((tag: string) => (
                                                            <span class="inline-block px-1.5 py-0.5 text-[10px] font-mono tracking-wide text-accent bg-accent/10 border border-accent/20 rounded-sm">
                                                                {tag}
                                                            </span>
                                                        ))}
                                                    </div>
                                                    <!-- Description -->
                                                    <p class="text-sm text-muted-foreground leading-relaxed line-clamp-2">
                                                        {post.data.description}
                                                    </p>
                                                </div>

                                                <!-- Date & Arrow -->
                                                <div class="flex-shrink-0 flex items-center gap-4">
                                                    <div class="hidden md:flex items-center gap-2 font-mono text-[11px] text-muted-foreground">
                                                        <span class="inline-block w-1.5 h-1.5 rounded-full bg-accent/60"></span>
                                                        <time datetime={post.data.pubDate.toISOString()}>
                                                            {formattedDate}
                                                        </time>
                                                    </div>

                                                    <!-- Hover Arrow -->
                                                    <div class="opacity-0 group-hover:opacity-100 transition-all duration-300 translate-x-2 group-hover:translate-x-0">
                                                        <svg class="w-4 h-4 text-accent" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                                            <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 19.5l15-15m0 0H8.25m11.25 0v11.25" />
                                                        </svg>
                                                    </div>
                                                </div>
                                            </div>

                                            {/* Mobile Date (falls below description on very small screens if needed, but mostly flex handles it) */}
                                            <div class="md:hidden flex items-center gap-2 font-mono text-[10px] text-muted-foreground py-2 border-t border-border mt-2">
                                                <span class="inline-block w-1 h-1 rounded-full bg-accent/60"></span>
                                                <time datetime={post.data.pubDate.toISOString()}>
                                                    {formattedDate}
                                                </time>
                                            </div>

                                            <!-- Bottom Accent Line (appears on hover) -->
                                            <div class="absolute bottom-0 left-0 right-0 h-0.5 bg-accent scale-x-0 group-hover:scale-x-100 transition-transform duration-500 origin-left"></div>
                                        </a>
                                    );
                                })}
                            </div>
                        ) : (
                            <div class="py-20 text-center border border-dashed border-border animate-slide-from-right">
                                <p class="font-mono text-sm text-muted-foreground uppercase tracking-wider mb-2">
                                    No Records Found.
                                </p>
                                <p class="text-xs text-muted-foreground font-mono">
                                    Initialize writing protocol...
                                </p>
                                <div class="mt-8 inline-block animate-pulse w-2 h-4 bg-accent" />
                            </div>
                        )}
                        <!-- No results message -->
                        <div id="no-results" class="hidden py-12 text-center font-mono text-sm text-muted-foreground uppercase tracking-wider">
                            No logs found for this tag.
                        </div>
                    </div>

                    <!-- Footer / System Info -->
                    <div class="mt-20 flex items-center gap-4">
                        <div class="h-px flex-1 bg-border"></div>
                        <span class="font-mono text-[10px] text-muted-foreground tracking-[0.3em] uppercase">
                            End_of_Logs
                        </span>
                        <div class="h-px flex-1 bg-border"></div>
                    </div>
                </div>

                <!-- Right Column: System Graph -->
                <div class="w-full lg:w-[400px] xl:w-[500px] h-[500px] lg:h-[calc(100vh-200px)] lg:sticky lg:top-8 self-start flex-shrink-0 animate-slide-from-right" style="animation-delay: 0.3s;">
                    <!-- Window Header Decor -->
                    <div class="flex items-center justify-between border-t border-x border-border bg-muted/30 px-3 py-1.5">
                        <span class="font-mono text-[9px] uppercase tracking-[0.2em] text-muted-foreground">Relation_Graph</span>
                        <div class="flex gap-1.5">
                            <div class="w-1.5 h-1.5 rounded-full bg-border"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-border"></div>
                            <div class="w-1.5 h-1.5 rounded-full bg-border"></div>
                        </div>
                    </div>
                    <!-- Client-only Graph -->
                    {posts.length > 0 && (
                        <SystemGraph 
                            client:only="react" 
                            nodes={graphNodes} 
                            links={graphLinks} 
                            className="rounded-t-none"
                        />
                    )}
                </div>
            </div>
        </main>
    </div>
</BaseLayout>

<style>
    .animate-line-drop {
        animation: scaleYDown 0.5s cubic-bezier(0.22, 1, 0.36, 1) both;
    }
    .animate-title-slide {
        animation: slideOutRight 0.7s cubic-bezier(0.22, 1, 0.36, 1) 0.1s both;
    }
    .animate-slide-from-right {
        animation: slideFromRight 0.8s cubic-bezier(0.22, 1, 0.36, 1) both;
    }

    @keyframes scaleYDown {
        0% { transform: scaleY(0); }
        100% { transform: scaleY(1); }
    }
    @keyframes slideOutRight {
        0% { transform: translateX(-100%); opacity: 0; }
        20% { opacity: 1; }
        100% { transform: translateX(0); opacity: 1; }
    }
    @keyframes slideFromRight {
        0% { transform: translateX(20px); opacity: 0; }
        15% { opacity: 1; }
        100% { transform: translateX(0); opacity: 1; }
    }

    .line-clamp-2 {
        display: -webkit-box;
        -webkit-line-clamp: 2;
        -webkit-box-orient: vertical;
        overflow: hidden;
    }
</style>

<script>
    function applyFilter(tagName: string | null) {
        const banner = document.getElementById('filter-banner');
        const tagLabel = document.getElementById('filter-tag-name');
        const noResults = document.getElementById('no-results');
        const cards = document.querySelectorAll('.blog-card') as NodeListOf<HTMLElement>;

        if (!tagName) {
            // Show all
            banner?.classList.add('hidden');
            cards.forEach(card => {
                card.style.display = '';
            });
            noResults?.classList.add('hidden');
            return;
        }

        // Show filter banner
        banner?.classList.remove('hidden');
        if (tagLabel) tagLabel.textContent = tagName;

        let visibleCount = 0;
        const lowerTag = tagName.toLowerCase();
        cards.forEach(card => {
            const tags: string[] = JSON.parse(card.dataset.tags || '[]');
            if (tags.includes(lowerTag)) {
                card.style.display = '';
                visibleCount++;
            } else {
                card.style.display = 'none';
            }
        });

        if (visibleCount === 0) {
            noResults?.classList.remove('hidden');
        } else {
            noResults?.classList.add('hidden');
        }
    }

    // Apply filter from URL on load
    const params = new URLSearchParams(window.location.search);
    const initialTag = params.get('tag');
    if (initialTag) {
        applyFilter(initialTag);
    }

    // Clear filter button
    document.getElementById('filter-clear')?.addEventListener('click', () => {
        window.location.href = '/blog';
    });
</script>
