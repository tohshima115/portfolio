---
import { getCollection } from "astro:content";
import { ClientRouter } from "astro:transitions";
import "../styles/global.css";
import { PrtsInterface } from "../components/pages/home/PrtsInterface";

const projects = await getCollection("projects");
const blogPosts = await getCollection("blog");

// Merge and sort updates
const allUpdates = [
	...projects.map((p) => ({
		title: p.data.title,
		date: p.data.meta.updatedDate
			? new Date(p.data.meta.updatedDate)
			: new Date(p.data.meta.date),
		url: `/works/${p.slug}`,
		type: "works" as const,
	})),
	...blogPosts.map((b) => ({
		title: b.data.title,
		date: b.data.updatedDate
			? new Date(b.data.updatedDate)
			: new Date(b.data.pubDate),
		url: `/blog/${b.slug}`,
		type: "blog" as const,
	})),
].sort((a, b) => b.date.valueOf() - a.date.valueOf());

const latestUpdates = allUpdates.slice(0, 3).map((u) => ({
	...u,
	date: u.date.toISOString(), // passed via props, keep as string
}));
---

<html lang="ja">
	<head>
		<meta charset="utf-8" />
		<link rel="icon" type="image/svg+xml" href="/favicon.svg" />
		<link rel="icon" href="/favicon.ico" />
		<meta name="viewport" content="width=device-width" />
		<meta name="generator" content={Astro.generator} />
		<title>Shogo Toyoshima Portfolio</title>
		<meta
			name="description"
			content="Design Engineer / UX Researcher ポートフォリオサイト"
		/>
		<ClientRouter />
	</head>
	<body class="min-h-screen">
		<PrtsInterface client:load updates={latestUpdates} />
		<script is:inline>
			document.addEventListener("astro:before-swap", (e) => {
				if (window.location.pathname === "/") {
					e.newDocument.documentElement.classList.add(
						"exiting-from-top"
					);
				}
			});
		</script>
	</body>
</html>
